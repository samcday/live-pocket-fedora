#!/bin/bash
set -euxo pipefail

: "${SRCDIR:?}"

SMOO_DIR="${SRCDIR}/smoo"
if [[ ! -d "${SMOO_DIR}" ]]; then
    echo "smoo source tree not found at ${SMOO_DIR}" >&2
    exit 1
fi

export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-/var/cache/smoo/target}"
mkdir -p "${CARGO_TARGET_DIR}"

cd "${SMOO_DIR}"
cargo build --release --locked --bin smoo-gadget-cli
install -Dm0755 "${CARGO_TARGET_DIR}/release/smoo-gadget-cli" /usr/bin/smoo-gadget
ln -sf smoo-gadget /usr/bin/smoo-gadget-cli
